<!doctype html>
<html lang="id">
<head>
  <!-- =========================
    BLOK 1 — META / SEO / PWA-LITE
  ========================== -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#070612" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Mystery Box Deposit — Demo</title>

  <!-- =========================
    BLOK 2 — FONTS
  ========================== -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    /* =========================
      BLOK 3 — THEME TOKENS (VISION-GLASS)
    ========================== */
    :root{
      --bg0:#070612;
      --bg1:#120a2d;
      --bg2:#1a1143;

      --glass: rgba(255,255,255,.08);
      --glass2: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.14);
      --stroke2: rgba(255,255,255,.10);

      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --faint: rgba(255,255,255,.50);

      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --shadow2: 0 10px 28px rgba(0,0,0,.35);

      --radius: 22px;
      --radius2: 16px;
      --pad: 18px;

      --gold:#f7d77a;
      --gold2:#ffd36a;
      --purple:#a56bff;
      --cyan:#5ef6ff;
      --green:#4dffab;
      --red:#ff4d6d;

      --easeOut: cubic-bezier(.16,1,.3,1);
      --easeSmall: cubic-bezier(.2,.8,.2,1);
      --easeSpring: cubic-bezier(.2,1.3,.2,1);
    }

    /* =========================
      BLOK 4 — RESET / BASE
    ========================== */
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(165,107,255,.22), transparent 55%),
        radial-gradient(1000px 700px at 85% 20%, rgba(94,246,255,.14), transparent 55%),
        radial-gradient(900px 700px at 50% 95%, rgba(247,215,122,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 55%, var(--bg0));
      overflow-x:hidden;
    }
    a{ color:inherit; text-decoration:none; }
    button, input, select, textarea{ font:inherit; color:inherit; }
    ::selection{ background: rgba(165,107,255,.28); }

    @media (prefers-reduced-motion: reduce){
      *{ animation: none !important; transition: none !important; scroll-behavior: auto !important; }
    }

    /* =========================
      BLOK 5 — BACKDROP (NOISE + SPARKS)
    ========================== */
    .noise{
      position:fixed; inset:0;
      pointer-events:none; z-index:0;
      opacity:.08;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='.5'/%3E%3C/svg%3E");
      mix-blend-mode: overlay;
    }
    .sparks{
      position:fixed; inset:-20%;
      pointer-events:none; z-index:0;
      background:
        radial-gradient(3px 3px at 10% 20%, rgba(255,255,255,.55), transparent 60%),
        radial-gradient(2px 2px at 70% 30%, rgba(255,255,255,.35), transparent 60%),
        radial-gradient(2.4px 2.4px at 40% 80%, rgba(255,255,255,.28), transparent 60%),
        radial-gradient(2px 2px at 90% 65%, rgba(255,255,255,.25), transparent 60%),
        radial-gradient(3px 3px at 25% 55%, rgba(255,214,106,.28), transparent 60%),
        radial-gradient(2px 2px at 55% 18%, rgba(165,107,255,.26), transparent 60%),
        radial-gradient(3px 3px at 78% 86%, rgba(94,246,255,.18), transparent 60%);
      filter: blur(.2px);
      animation: drift 14s linear infinite;
      opacity:.7;
    }
    @keyframes drift{
      0%{ transform: translate3d(0,0,0) rotate(0deg); }
      100%{ transform: translate3d(4%, -3%, 0) rotate(6deg); }
    }

    /* =========================
      BLOK 6 — LAYOUT / SHELL
    ========================== */
    .wrap{
      position:relative;
      z-index:1;
      max-width:1180px;
      margin:0 auto;
      padding: 26px 18px 40px;
    }

    .topbar{
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:18px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      user-select:none;
      min-width: 260px;
    }
    .logo{
      width:44px; height:44px; border-radius:14px;
      background:
        radial-gradient(18px 18px at 30% 25%, rgba(255,255,255,.45), transparent 55%),
        radial-gradient(90px 70px at 60% 70%, rgba(247,215,122,.24), transparent 60%),
        linear-gradient(135deg, rgba(165,107,255,.65), rgba(94,246,255,.35));
      box-shadow: 0 18px 60px rgba(165,107,255,.18), 0 14px 32px rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.14);
      flex: 0 0 auto;
    }
    .brand h1{
      font-size:16px; margin:0;
      letter-spacing:.2px;
      line-height:1.05;
    }
    .brand p{
      margin:2px 0 0; font-size:12px; color:var(--muted);
    }

    .pill{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(14px) saturate(155%);
      -webkit-backdrop-filter: blur(14px) saturate(155%);
      white-space: nowrap;
    }
    .pill small{ color:var(--muted); }
    .pill b{ font-weight:800; letter-spacing:.2px; }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.9), rgba(255,255,255,0) 55%), rgba(94,246,255,.55);
      box-shadow: 0 0 0 3px rgba(94,246,255,.12), 0 0 18px rgba(94,246,255,.28);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:16px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.12);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(20px) saturate(170%);
      -webkit-backdrop-filter: blur(20px) saturate(170%);
      overflow:hidden;
    }
    .card .head{
      padding: 16px 18px 12px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:
        radial-gradient(600px 220px at 20% 0%, rgba(165,107,255,.18), transparent 60%),
        radial-gradient(520px 240px at 90% 10%, rgba(94,246,255,.12), transparent 58%);
    }
    .head h2{
      font-size:14px;
      letter-spacing:.25px;
      margin:0 0 6px;
    }
    .head p{
      margin:0;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }
    .card .body{ padding: 16px 18px 18px; }

    .seg{
      display:flex; gap:8px; flex-wrap:wrap;
      padding: 4px;
      border-radius: 999px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
    }
    .seg button{
      border:0;
      background: transparent;
      padding: 10px 12px;
      border-radius: 999px;
      color: var(--muted);
      cursor:pointer;
      transition: transform .15s var(--easeOut), background .2s var(--easeOut), color .2s var(--easeOut);
    }
    .seg button[aria-selected="true"]{
      background: rgba(255,255,255,.10);
      color: var(--text);
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
    }
    .seg button:active{ transform: scale(.98); }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 560px){
      .row{ grid-template-columns: 1fr; }
    }

    .field{
      display:flex; flex-direction:column; gap:6px;
    }
    .field label{
      font-size:12px;
      color: var(--muted);
    }
    .field input, .field select, .field textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.24);
      outline:none;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
      transition: border-color .2s var(--easeOut), box-shadow .2s var(--easeOut);
    }
    .field input:focus, .field select:focus, .field textarea:focus{
      border-color: rgba(94,246,255,.35);
      box-shadow: 0 0 0 4px rgba(94,246,255,.12);
    }

    .btns{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top: 12px;
    }
    .btn{
      border:0;
      cursor:pointer;
      padding: 12px 14px;
      border-radius: 16px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 14px 32px rgba(0,0,0,.28);
      transition: transform .15s var(--easeOut), filter .2s var(--easeOut), background .2s var(--easeOut);
      display:inline-flex; align-items:center; gap:10px;
      user-select:none;
    }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; filter: grayscale(.15); }
    .btn:hover{ filter: brightness(1.06); }
    .btn:active{ transform: scale(.985); }
    .btn.primary{
      background:
        radial-gradient(14px 14px at 30% 25%, rgba(255,255,255,.40), transparent 55%),
        linear-gradient(135deg, rgba(165,107,255,.75), rgba(94,246,255,.38));
      border-color: rgba(255,255,255,.18);
    }
    .btn.danger{
      background: rgba(255,77,109,.14);
      border-color: rgba(255,77,109,.22);
    }
    .btn.good{
      background: rgba(77,255,171,.12);
      border-color: rgba(77,255,171,.22);
    }
    .btn.ghost{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.12);
      box-shadow:none;
    }
    .btn small{ color: rgba(255,255,255,.78); }
    .btn .k{
      width:22px; height:22px; border-radius:8px;
      background: rgba(0,0,0,.26);
      border: 1px solid rgba(255,255,255,.12);
      display:grid; place-items:center;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.05);
      font-size: 12px;
    }

    .note{
      padding: 12px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      font-size:12px;
      line-height:1.5;
    }
    .note b{ color: var(--text); }

    .list{
      display:flex; flex-direction:column; gap:10px;
      margin-top:12px;
    }
    .item{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius: 18px;
      padding: 12px 12px;
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .item .left{ min-width:0; }
    .item .title{
      margin:0; font-size:13px; font-weight:800;
      letter-spacing:.2px;
    }
    .item .meta{
      margin:4px 0 0;
      font-size:12px; color: var(--muted);
      line-height:1.35;
      word-break:break-word;
    }
    .item .right{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .tag{
      font-size:11px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.86);
      white-space: nowrap;
    }
    .tag.warn{
      border-color: rgba(247,215,122,.22);
      background: rgba(247,215,122,.10);
    }
    .tag.good{
      border-color: rgba(77,255,171,.24);
      background: rgba(77,255,171,.10);
    }
    .tag.bad{
      border-color: rgba(255,77,109,.26);
      background: rgba(255,77,109,.12);
    }

    /* =========================
      BLOK 7 — HERO / BOX ILLUSTRATION
    ========================== */
    .hero{
      position:relative;
      padding: 18px 18px 14px;
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(740px 240px at 15% 0%, rgba(165,107,255,.18), transparent 55%),
        radial-gradient(640px 260px at 90% 20%, rgba(94,246,255,.14), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow2);
      overflow:hidden;
      margin-bottom: 16px;
    }
    .heroGrid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
      align-items:center;
    }
    @media (max-width: 820px){
      .heroGrid{ grid-template-columns: 1fr; }
    }
    .hero h3{
      margin:0 0 8px;
      font-size:18px;
      letter-spacing:.2px;
    }
    .hero .sub{
      margin:0;
      font-size:12.5px;
      color: var(--muted);
      line-height: 1.45;
    }

    .boxArt{
      position:relative;
      height: 150px;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(160px 120px at 30% 25%, rgba(255,255,255,.18), transparent 60%),
        radial-gradient(220px 180px at 70% 70%, rgba(247,215,122,.16), transparent 65%),
        linear-gradient(135deg, rgba(165,107,255,.32), rgba(94,246,255,.16));
      box-shadow: 0 24px 70px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .boxArt::before{
      content:"";
      position:absolute; inset:-40%;
      background:
        conic-gradient(from 210deg, rgba(255,255,255,.0), rgba(255,255,255,.14), rgba(255,255,255,0) 55%),
        radial-gradient(closest-side, rgba(255,255,255,.12), transparent 68%);
      filter: blur(1px);
      animation: sheen 5.8s linear infinite;
      opacity:.65;
    }
    .boxCube{
      position:absolute;
      left:50%; top:54%;
      width: 96px; height: 76px;
      transform: translate(-50%,-50%) rotateX(12deg);
      border-radius: 18px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.20), rgba(255,255,255,.06)),
        radial-gradient(70px 60px at 30% 20%, rgba(255,255,255,.28), transparent 55%),
        linear-gradient(135deg, rgba(247,215,122,.55), rgba(165,107,255,.28));
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
    }
    .boxLid{
      position:absolute;
      left:50%; top:36%;
      width: 104px; height: 26px;
      transform: translate(-50%,-50%);
      border-radius: 16px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.22), rgba(255,255,255,.08)),
        linear-gradient(135deg, rgba(94,246,255,.26), rgba(165,107,255,.22));
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: 0 14px 32px rgba(0,0,0,.35);
      animation: bob 2.8s var(--easeSmall) infinite;
      transform-origin: 50% 100%;
    }
    .boxBand{
      position:absolute; left:50%; top:54%;
      width: 110px; height: 10px;
      transform: translate(-50%,-50%);
      border-radius: 999px;
      background: rgba(0,0,0,.20);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.05);
    }
    .glowOrb{
      position:absolute;
      right: -16px; bottom: -16px;
      width: 120px; height: 120px;
      border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), rgba(255,255,255,0) 55%), rgba(94,246,255,.20);
      filter: blur(.2px);
      box-shadow: 0 0 0 18px rgba(94,246,255,.08), 0 0 80px rgba(94,246,255,.22);
      opacity:.75;
    }
    @keyframes sheen{
      0%{ transform: translate3d(-4%,-2%,0) rotate(0deg); }
      100%{ transform: translate3d(4%,2%,0) rotate(360deg); }
    }
    @keyframes bob{
      0%,100%{ transform: translate(-50%,-50%) rotate(0deg); }
      50%{ transform: translate(-50%,-56%) rotate(-3deg); }
    }

    /* =========================
      BLOK 8 — TABLE (ODDS)
    ========================== */
    .tableWrap{
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
    }
    table{
      width:100%;
      border-collapse: collapse;
      font-size:12px;
    }
    thead th{
      text-align:left;
      padding: 12px 12px;
      color: rgba(255,255,255,.82);
      background: rgba(255,255,255,.06);
      border-bottom: 1px solid rgba(255,255,255,.08);
      font-weight:800;
      letter-spacing:.2px;
    }
    tbody td{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      color: rgba(255,255,255,.88);
      vertical-align: top;
    }
    tbody tr:last-child td{ border-bottom:0; }
    .pct{
      text-align:right;
      font-variant-numeric: tabular-nums;
      color: rgba(255,255,255,.86);
      white-space:nowrap;
    }

    /* =========================
      BLOK 9 — TOAST
    ========================== */
    .toast{
      position: fixed;
      left:50%;
      bottom: 18px;
      transform: translateX(-50%);
      z-index: 999;
      padding: 12px 14px;
      border-radius: 999px;
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(16px) saturate(160%);
      -webkit-backdrop-filter: blur(16px) saturate(160%);
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      display:none;
      gap:10px;
      align-items:center;
      max-width: calc(100vw - 24px);
      color: rgba(255,255,255,.90);
      font-size:12.5px;
    }
    .toast.show{ display:flex; animation: pop .32s var(--easeSpring); }
    @keyframes pop{
      0%{ transform: translateX(-50%) translateY(8px) scale(.98); opacity:0; }
      100%{ transform: translateX(-50%) translateY(0) scale(1); opacity:1; }
    }
    .toast .tDot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(255,255,255,.18);
      box-shadow: 0 0 0 3px rgba(255,255,255,.06);
    }
    .toast.good .tDot{ background: rgba(77,255,171,.60); box-shadow:0 0 0 3px rgba(77,255,171,.14), 0 0 18px rgba(77,255,171,.22); }
    .toast.bad  .tDot{ background: rgba(255,77,109,.60); box-shadow:0 0 0 3px rgba(255,77,109,.14), 0 0 18px rgba(255,77,109,.20); }
    .toast.warn .tDot{ background: rgba(247,215,122,.70); box-shadow:0 0 0 3px rgba(247,215,122,.14), 0 0 18px rgba(247,215,122,.20); }

    /* =========================
      BLOK 10 — SMALL UTILITIES
    ========================== */
    .muted{ color: var(--muted); }
    .faint{ color: var(--faint); }
    .hr{
      height:1px;
      background: rgba(255,255,255,.08);
      margin: 14px 0;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .mini{
      font-size:11.5px;
      color: var(--muted);
      line-height:1.45;
    }
    .rightActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
  </style>
</head>

<body>
  <div class="sparks"></div>
  <div class="noise"></div>

  <div class="wrap">
    <!-- =========================
      BLOK 11 — TOPBAR
    ========================== -->
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Mystery Box Deposit</h1>
          <p>Deposit ≥ <b>Rp20.000</b> → Ajukan Claim → Kode Voucher → Box Aktif → Buka Box</p>
        </div>
      </div>

      <div class="pill" title="Demo lokal (LocalStorage)">
        <span class="dot" aria-hidden="true"></span>
        <div>
          <small>Status</small><br>
          <b id="pillStatus">Demo aktif</b>
        </div>
      </div>
    </div>

    <!-- =========================
      BLOK 12 — HERO
    ========================== -->
    <div class="hero">
      <div class="heroGrid">
        <div>
          <h3>Konsep realistis: CS verifikasi, sistem menentukan hadiah</h3>
          <p class="sub">
            Kode voucher <b>sekali pakai</b> dan <b>terikat username + transaksi</b>. Expired <b>15–30 menit</b>.
            Maksimal <b>3x</b> percobaan input kode. Hadiah “Spin manual” punya masa aktif <b>24 jam</b>.
          </p>

          <div class="hr"></div>

          <div class="note">
            <b>Catatan jujur untuk produksi:</b> Ini demo front-end. Untuk benar-benar aman & anti manipulasi,
            generate kode + RNG hadiah + pencatatan harus <b>server-side</b>. Integrasi provider butuh bonus engine/aggregator.
          </div>
        </div>

        <div class="boxArt" aria-hidden="true">
          <div class="boxLid"></div>
          <div class="boxCube"></div>
          <div class="boxBand"></div>
          <div class="glowOrb"></div>
        </div>
      </div>
    </div>

    <!-- =========================
      BLOK 13 — MAIN GRID
    ========================== -->
    <div class="grid">
      <!-- =========================
        BLOK 13A — MEMBER / CS PANEL (LEFT)
      ========================== -->
      <div class="card">
        <div class="head">
          <div>
            <h2>Panel Event</h2>
            <p>Simulasi: ajukan claim → verifikasi CS → kode → box aktif → hadiah.</p>
          </div>
          <div class="seg" role="tablist" aria-label="Mode panel">
            <button id="tabMember" role="tab" aria-selected="true" aria-controls="viewMember" tabindex="0">Member</button>
            <button id="tabCS" role="tab" aria-selected="false" aria-controls="viewCS" tabindex="-1">CS</button>
          </div>
        </div>

        <div class="body">
          <!-- =========================
            BLOK 13A.1 — MEMBER VIEW
          ========================== -->
          <section id="viewMember" role="tabpanel" aria-labelledby="tabMember">
            <div class="row">
              <div class="field">
                <label>Username</label>
                <input id="m_username" placeholder="contoh: garr123" autocomplete="off" />
              </div>
              <div class="field">
                <label>Nominal Deposit (Rp)</label>
                <input id="m_nominal" placeholder="20000" inputmode="numeric" autocomplete="off" />
              </div>
            </div>

            <div class="row" style="margin-top:12px;">
              <div class="field">
                <label>Referensi Transaksi / TRX ID</label>
                <input id="m_trx" placeholder="contoh: TRX-20251206-001" autocomplete="off" />
              </div>
              <div class="field">
                <label>Bukti deposit (opsional, link/teks)</label>
                <input id="m_proof" placeholder="opsional" autocomplete="off" />
              </div>
            </div>

            <div class="btns">
              <button class="btn primary" id="btnSubmitClaim">
                <span class="k">✓</span> Ajukan Claim
              </button>
              <button class="btn ghost" id="btnFillDemo">
                <span class="k">★</span> Isi Contoh
              </button>
            </div>

            <div class="hr"></div>

            <h2 style="font-size:14px; margin:0 0 8px;">Aktivasi Box (Input Kode Voucher)</h2>
            <p class="mini" style="margin-top:0;">
              Masukkan <b>username</b>, <b>TRX</b>, dan <b>kode</b> dari CS. Kode berlaku 15–30 menit, dan maksimal 3x percobaan.
            </p>

            <div class="row">
              <div class="field">
                <label>Username</label>
                <input id="a_username" placeholder="harus sama seperti claim" autocomplete="off" />
              </div>
              <div class="field">
                <label>TRX ID</label>
                <input id="a_trx" placeholder="harus sama seperti claim" autocomplete="off" />
              </div>
            </div>

            <div class="row" style="margin-top:12px;">
              <div class="field" style="grid-column: 1 / -1;">
                <label>Kode Voucher</label>
                <input id="a_code" class="mono" placeholder="contoh: 8KQ7J2MZ" autocomplete="off" />
              </div>
            </div>

            <div class="btns">
              <button class="btn good" id="btnActivate">
                <span class="k">⚡</span> Aktivasi Box
              </button>
            </div>

            <div class="hr"></div>

            <h2 style="font-size:14px; margin:0 0 8px;">Kotak Saya</h2>
            <div id="myBoxes" class="list" aria-live="polite"></div>

            <div class="hr"></div>

            <h2 style="font-size:14px; margin:0 0 8px;">Hadiah Saya</h2>
            <div id="myRewards" class="list" aria-live="polite"></div>
          </section>

          <!-- =========================
            BLOK 13A.2 — CS VIEW
          ========================== -->
          <section id="viewCS" role="tabpanel" aria-labelledby="tabCS" style="display:none;">
            <div class="note">
              <b>Aturan tegas:</b><br>
              • Kode <b>sekali pakai</b>, terikat <b>username + transaksi</b><br>
              • Expired cepat <b>15–30 menit</b><br>
              • Limit percobaan input kode <b>3x</b><br>
              <span class="faint">Demo ini client-side. Produksi wajib server-side untuk anti manipulasi.</span>
            </div>

            <div class="hr"></div>

            <div class="row">
              <div class="field">
                <label>Expired kode (menit)</label>
                <select id="cs_expiry">
                  <option value="15">15 menit</option>
                  <option value="20" selected>20 menit</option>
                  <option value="30">30 menit</option>
                </select>
              </div>
              <div class="field">
                <label>Panjang kode</label>
                <select id="cs_len">
                  <option value="6">6 karakter</option>
                  <option value="8" selected>8 karakter</option>
                  <option value="10">10 karakter</option>
                </select>
              </div>
            </div>

            <div class="btns">
              <button class="btn ghost" id="btnSeedDemo">
                <span class="k">➕</span> Buat 2 Claim Dummy
              </button>
              <button class="btn danger" id="btnResetAll">
                <span class="k">↺</span> Reset Demo Data
              </button>
            </div>

            <div class="hr"></div>

            <h2 style="font-size:14px; margin:0 0 8px;">Claim Masuk (Pending)</h2>
            <div id="csPending" class="list"></div>

            <div class="hr"></div>

            <h2 style="font-size:14px; margin:0 0 8px;">Claim Terverifikasi (Re-issue Kode)</h2>
            <div id="csVerified" class="list"></div>

            <div class="hr"></div>

            <h2 style="font-size:14px; margin:0 0 8px;">Kode Aktif</h2>
            <div id="csCodes" class="list"></div>

            <div class="hr"></div>

            <h2 style="font-size:14px; margin:0 0 8px;">Audit Log</h2>
            <div id="csAudit" class="list"></div>
          </section>
        </div>
      </div>

      <!-- =========================
        BLOK 13B — ODDS + RULES (RIGHT)
      ========================== -->
      <div class="card">
        <div class="head">
          <div>
            <h2>Peluang Hadiah (Transparan)</h2>
            <p>Total 100%. Untuk produksi: pindah ke server-side agar fair & audit-able.</p>
          </div>
          <div class="rightActions">
            <span class="tag warn" title="Masa aktif hadiah spin">Spin aktif 24 jam</span>
            <span class="tag" title="Provider yang berlaku">PRAGMATIC • PGSOFT</span>
          </div>
        </div>

        <div class="body">
          <div class="tableWrap" aria-label="Tabel peluang hadiah">
            <table>
              <thead>
                <tr>
                  <th>Hadiah</th>
                  <th style="width:110px; text-align:right;">Peluang</th>
                </tr>
              </thead>
              <tbody id="oddsTbody"></tbody>
            </table>
          </div>

          <div class="hr"></div>

          <div class="note">
            <b>Spin manual (paket final):</b><br>
            • 10x — nilai/spin Rp400<br>
            • 50x — nilai/spin Rp1.000<br>
            • 100x — nilai/spin Rp2.000<br>
            <span class="faint">Masa aktif 24 jam.</span>
          </div>

          <div class="hr"></div>

          <div class="note">
            <b>Best practice anti-komplain:</b><br>
            • Tampilkan riwayat hadiah per user<br>
            • Jelaskan definisi “spin” + provider berlaku<br>
            • Flow rapi: Aktivasi → Box aktif → Buka box (tanpa bolak-balik konfirmasi)
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- =========================
    BLOK 14 — TOAST
  ========================== -->
  <div class="toast" id="toast" role="status" aria-live="polite">
    <span class="tDot" aria-hidden="true"></span>
    <span id="toastText">—</span>
  </div>

  <script>
    /* =========================
      BLOK 15 — DATA MODEL (DEMO STORAGE) — HARDENED
      - Fix bug rewardLabel
      - Remove XSS surface: render with DOM + textContent
      - Add re-issue code flow (verified claims)
      - Make activation robust (attempts, expiry, opened box guard)
      - No heavy re-render every second; tick updates countdown only
    ========================== */

    const STORE_KEY_V2 = "mystery_box_deposit_demo_v2";
    const STORE_KEY_V1 = "mystery_box_deposit_demo_v1";
    const SCHEMA = 2;

    const ODDS = [
      { id:"cb5",   label:"Cashback 5% (maks Rp1.000)",   type:"cashback", pct:49.5, data:{percent:5, cap:1000} },
      { id:"cb8",   label:"Cashback 8% (maks Rp2.000)",   type:"cashback", pct:18.0, data:{percent:8, cap:2000} },
      { id:"cb12",  label:"Cashback 12% (maks Rp3.000)",  type:"cashback", pct:10.0, data:{percent:12, cap:3000} },
      { id:"cb20",  label:"Cashback 20% (maks Rp5.000)",  type:"cashback", pct:5.0,  data:{percent:20, cap:5000} },
      { id:"cb50",  label:"Cashback 50% (maks Rp10.000)", type:"cashback", pct:0.5,  data:{percent:50, cap:10000} },

      { id:"sp10",  label:"Spin 10x (Rp400/spin) — Pragmatic/PGSoft",   type:"spin",   pct:12.0, data:{spins:10,  bet:400} },
      { id:"sp50",  label:"Spin 50x (Rp1.000/spin) — Pragmatic/PGSoft", type:"spin",   pct:3.8,  data:{spins:50,  bet:1000} },
      { id:"sp100", label:"Spin 100x (Rp2.000/spin) — Pragmatic/PGSoft",type:"spin",   pct:0.7,  data:{spins:100, bet:2000} },

      { id:"v50k",  label:"Voucher Rp50.000",   type:"voucher", pct:0.45, data:{amount:50000} },
      { id:"v1jt",  label:"Voucher Rp1.000.000",type:"voucher", pct:0.05, data:{amount:1000000} },
    ];

    /* =========================
      BLOK 16 — HELPERS
    ========================== */
    const $ = (id)=> document.getElementById(id);
    function now(){ return Date.now(); }

    function safeJSONParse(s, fallback){
      try{ return JSON.parse(s); }catch(e){ return fallback; }
    }

    function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

    function fmtMoney(n){
      const x = Math.max(0, Math.floor(Number(n)||0));
      return "Rp" + x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function fmtTime(ts){
      const d = new Date(ts);
      const pad = (v)=> String(v).padStart(2,"0");
      return `${pad(d.getDate())}-${pad(d.getMonth()+1)}-${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function msLeft(ts){ return Math.max(0, ts - now()); }

    function fmtLeftCompact(ms){
      const s = Math.floor(ms/1000);
      const m = Math.floor(s/60);
      const r = s%60;
      return `${m}m ${String(r).padStart(2,"0")}s`;
    }

    function fmtLeftHours(ms){
      const s = Math.floor(ms/1000);
      const h = Math.floor(s/3600);
      const m = Math.floor((s%3600)/60);
      return `${h}j ${String(m).padStart(2,"0")}m`;
    }

    function uid(prefix="id"){
      // demo only (not cryptographically unique)
      return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }

    function parseNominal(raw){
      const n = String(raw||"").replace(/[^\d]/g,"");
      const v = Math.floor(Number(n)||0);
      return Number.isFinite(v) ? v : 0;
    }

    function normalizeUsername(s){
      const v = String(s||"").trim();
      // long-term: keep simple to avoid XSS + weird parsing
      if(!v) return { ok:false, v:"", why:"Username wajib diisi." };
      if(v.length < 3) return { ok:false, v, why:"Username minimal 3 karakter." };
      if(v.length > 32) return { ok:false, v, why:"Username terlalu panjang (maks 32)." };
      if(!/^[a-zA-Z0-9._-]+$/.test(v)) return { ok:false, v, why:"Username hanya boleh huruf/angka . _ -" };
      return { ok:true, v };
    }

    function normalizeTRX(s){
      const v = String(s||"").trim();
      if(!v) return { ok:false, v:"", why:"TRX wajib diisi." };
      if(v.length < 6) return { ok:false, v, why:"TRX terlalu pendek." };
      if(v.length > 64) return { ok:false, v, why:"TRX terlalu panjang (maks 64)." };
      // allow wider set
      if(!/^[a-zA-Z0-9._:@/-]+$/.test(v)) return { ok:false, v, why:"TRX berisi karakter tidak valid." };
      return { ok:true, v };
    }

    /* =========================
      BLOK 17 — CRYPTO (HASH + RNG)
    ========================== */
    async function sha256Hex(text){
      if (window.crypto && crypto.subtle && window.TextEncoder) {
        const enc = new TextEncoder().encode(text);
        const buf = await crypto.subtle.digest("SHA-256", enc);
        const arr = Array.from(new Uint8Array(buf));
        return arr.map(b=>b.toString(16).padStart(2,"0")).join("");
      }
      // fallback (demo-only)
      let h=2166136261;
      for(let i=0;i<text.length;i++){
        h ^= text.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return ("00000000"+(h>>>0).toString(16)).slice(-8) + "_demo";
    }

    function randCode(len=8){
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; // no 0/1/I/O
      let out = "";
      const arr = new Uint32Array(len);
      if (window.crypto && crypto.getRandomValues) crypto.getRandomValues(arr);
      for(let i=0;i<len;i++){
        const r = arr[i] ? arr[i] : Math.floor(Math.random()*1e9);
        out += chars[r % chars.length];
      }
      return out;
    }

    function randFloat01(){
      if(window.crypto && crypto.getRandomValues){
        const a = new Uint32Array(1);
        crypto.getRandomValues(a);
        // 0..(2^32-1) -> 0..1
        return a[0] / 4294967295;
      }
      return Math.random();
    }

    /* =========================
      BLOK 18 — TOAST
    ========================== */
    let toastTimer = null;
    function toast(msg, kind=""){
      const el = $("toast");
      const tx = $("toastText");
      tx.textContent = msg;
      el.className = "toast show" + (kind ? " " + kind : "");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> el.className="toast", 2300);
    }

    /* =========================
      BLOK 19 — STATE (LOAD + MIGRATE + SAVE)
    ========================== */
    const state = loadState();

    function defaultState(){
      return { schema: SCHEMA, claims:[], codes:[], boxes:[], rewards:[], audit:[] };
    }

    function loadState(){
      const base = defaultState();
      const raw2 = localStorage.getItem(STORE_KEY_V2);
      if(raw2){
        const parsed = safeJSONParse(raw2, base);
        return hardenState(parsed);
      }
      // migrate from V1 if exists
      const raw1 = localStorage.getItem(STORE_KEY_V1);
      if(raw1){
        const v1 = safeJSONParse(raw1, null);
        if(v1 && typeof v1 === "object"){
          const migrated = migrateV1toV2(v1);
          localStorage.setItem(STORE_KEY_V2, JSON.stringify(migrated));
          return migrated;
        }
      }
      return base;
    }

    function hardenState(s){
      const base = defaultState();
      const x = (s && typeof s === "object") ? s : base;
      return {
        schema: SCHEMA,
        claims:  Array.isArray(x.claims)  ? x.claims  : [],
        codes:   Array.isArray(x.codes)   ? x.codes   : [],
        boxes:   Array.isArray(x.boxes)   ? x.boxes   : [],
        rewards: Array.isArray(x.rewards) ? x.rewards : [],
        audit:   Array.isArray(x.audit)   ? x.audit   : []
      };
    }

    function migrateV1toV2(v1){
      const s = defaultState();
      // keep same arrays but normalize fields
      const claims = Array.isArray(v1.claims) ? v1.claims : [];
      const codes  = Array.isArray(v1.codes)  ? v1.codes  : [];
      const boxes  = Array.isArray(v1.boxes)  ? v1.boxes  : [];
      const rewards= Array.isArray(v1.rewards)? v1.rewards: [];
      const audit  = Array.isArray(v1.audit)  ? v1.audit  : [];

      // claims: pending/approved/rejected -> pending/verified/rejected
      s.claims = claims.map(c=>({
        id: c.id || uid("cl"),
        username: String(c.username||""),
        trx_ref: String(c.trx_ref||""),
        nominal: Math.floor(Number(c.nominal)||0),
        proof: String(c.proof||""),
        status: c.status === "approved" ? "verified" : (c.status === "rejected" ? "rejected" : "pending"),
        created_at: Number(c.created_at)||now(),
        reviewed_at: c.reviewed_at ? Number(c.reviewed_at) : null
      }));

      // codes: add claim_id unknown; keep username/trx; add superseded_at
      s.codes = codes.map(cd=>({
        id: cd.id || uid("cd"),
        claim_id: null,
        username: String(cd.username||""),
        trx_ref: String(cd.trx_ref||""),
        code_hash: String(cd.code_hash||""),
        code_preview: String(cd.code_preview||""), // demo-only
        expires_at: Number(cd.expires_at)||now(),
        attempts_left: clamp(Number(cd.attempts_left)||3, 0, 3),
        used_at: cd.used_at ? Number(cd.used_at) : null,
        created_at: Number(cd.created_at)||now(),
        superseded_at: null
      }));

      s.boxes = boxes.map(b=>({
        id: b.id || uid("bx"),
        claim_id: null,
        username: String(b.username||""),
        trx_ref: String(b.trx_ref||""),
        nominal: Math.floor(Number(b.nominal)||0),
        status: String(b.status||"locked"),
        created_at: Number(b.created_at)||now(),
        activated_at: b.activated_at ? Number(b.activated_at) : null,
        opened_at: b.opened_at ? Number(b.opened_at) : null
      }));

      s.rewards = rewards.map(r=>({
        id: r.id || uid("rw"),
        box_id: null,
        username: String(r.username||""),
        trx_ref: String(r.trx_ref||""),
        created_at: Number(r.created_at)||now(),
        type: String(r.type||""),
        title: String(r.title||"Hadiah"),
        expires_at: Number(r.expires_at)|| (now()+24*60*60*1000),
        status: String(r.status||"granted"),
        payload: (r.payload && typeof r.payload==="object") ? r.payload : {}
      }));

      s.audit = audit.map(a=>({
        id: a.id || uid("au"),
        ts: Number(a.ts)||now(),
        text: String(a.text||"")
      }));

      return s;
    }

    function save(){
      // derive statuses (expired reward)
      deriveStatuses();
      localStorage.setItem(STORE_KEY_V2, JSON.stringify(state));
      renderAll();
    }

    function deriveStatuses(){
      const t = now();
      for(const r of state.rewards){
        if(r.expires_at && r.expires_at <= t && r.status !== "completed"){
          r.status = "expired";
        }
      }
    }

    /* =========================
      BLOK 20 — BUSINESS LOGIC (HARDENED FLOW)
    ========================== */
    function addAudit(text){
      state.audit.unshift({ id: uid("au"), ts: now(), text: String(text||"") });
      state.audit = state.audit.slice(0, 80);
    }

    function validateNominalMin(n){
      const v = Math.floor(Number(n)||0);
      if (!Number.isFinite(v)) return { ok:false, v:0 };
      if (v < 20000) return { ok:false, v };
      return { ok:true, v };
    }

    function findClaim(username, trx){
      return state.claims.find(c => c.username === username && c.trx_ref === trx);
    }

    function findBox(username, trx){
      return state.boxes.find(b => b.username === username && b.trx_ref === trx);
    }

    function hasOpenedBox(username, trx){
      const b = findBox(username, trx);
      return !!(b && b.opened_at);
    }

    function getLatestActiveCode(username, trx){
      const t = now();
      const list = state.codes
        .filter(cd =>
          cd.username === username &&
          cd.trx_ref === trx &&
          !cd.used_at &&
          (!cd.superseded_at) &&
          cd.expires_at > t &&
          (cd.attempts_left || 0) > 0
        )
        .sort((a,b)=>(b.created_at||0)-(a.created_at||0));
      return list[0] || null;
    }

    function getClaimActiveCode(claim){
      if(!claim) return null;
      return getLatestActiveCode(claim.username, claim.trx_ref);
    }

    function invalidateOldCodesForClaim(claim){
      const t = now();
      for(const cd of state.codes){
        if(cd.username===claim.username && cd.trx_ref===claim.trx_ref && !cd.used_at && !cd.superseded_at && cd.expires_at > t){
          cd.superseded_at = t;
          cd.expires_at = t; // hard stop
        }
      }
    }

    async function issueCodeForClaim(claimId){
      const claim = state.claims.find(c=>c.id===claimId);
      if(!claim) return;

      if(claim.status !== "verified"){
        toast("Claim belum terverifikasi.", "warn");
        return;
      }
      if(hasOpenedBox(claim.username, claim.trx_ref)){
        toast("Box untuk TRX ini sudah dibuka. Jangan issue kode baru.", "bad");
        return;
      }

      const expMin = clamp(Number($("cs_expiry").value||20), 15, 30);
      const len = clamp(Number($("cs_len").value||8), 6, 10);

      // prevent multiple active codes: invalidate previous ones
      invalidateOldCodesForClaim(claim);

      const codePlain = randCode(len);
      const codeHash = await sha256Hex(codePlain);

      const expires_at = now() + expMin * 60 * 1000;

      state.codes.unshift({
        id: uid("cd"),
        claim_id: claim.id,
        username: claim.username,
        trx_ref: claim.trx_ref,
        code_hash: codeHash,
        // demo-only preview (hapus di produksi)
        code_preview: codePlain,
        expires_at,
        attempts_left: 3,
        used_at: null,
        created_at: now(),
        superseded_at: null
      });

      // ensure box exists locked
      let box = findBox(claim.username, claim.trx_ref);
      if(!box){
        state.boxes.unshift({
          id: uid("bx"),
          claim_id: claim.id,
          username: claim.username,
          trx_ref: claim.trx_ref,
          nominal: claim.nominal,
          status: "locked",
          created_at: now(),
          activated_at: null,
          opened_at: null
        });
      }

      addAudit(`CS issue kode: ${claim.username} • ${claim.trx_ref} (exp ${expMin}m)`);
      toast("Kode dibuat. Kirim ke member.", "good");
      save();
    }

    async function csApprove(claimId){
      const claim = state.claims.find(c=>c.id===claimId);
      if(!claim) return;
      if(claim.status !== "pending"){
        toast("Claim ini sudah diproses.", "warn");
        return;
      }

      claim.status = "verified";
      claim.reviewed_at = now();
      addAudit(`CS verifikasi: ${claim.username} • ${claim.trx_ref} • ${fmtMoney(claim.nominal)}`);

      // ensure box exists locked
      let box = findBox(claim.username, claim.trx_ref);
      if(!box){
        state.boxes.unshift({
          id: uid("bx"),
          claim_id: claim.id,
          username: claim.username,
          trx_ref: claim.trx_ref,
          nominal: claim.nominal,
          status: "locked",
          created_at: now(),
          activated_at: null,
          opened_at: null
        });
      }

      // auto-issue first code for verified claim
      await issueCodeForClaim(claim.id);
    }

    function csReject(claimId){
      const claim = state.claims.find(c=>c.id===claimId);
      if(!claim) return;
      if(claim.status !== "pending"){
        toast("Claim ini sudah diproses.", "warn");
        return;
      }
      claim.status = "rejected";
      claim.reviewed_at = now();
      addAudit(`CS reject: ${claim.username} • ${claim.trx_ref}`);
      toast("Claim ditolak.", "warn");
      save();
    }

    async function activateBox(){
      const u = normalizeUsername($("a_username").value);
      const t = normalizeTRX($("a_trx").value);
      const code = String($("a_code").value||"").trim().toUpperCase();

      if(!u.ok){ toast(u.why, "bad"); return; }
      if(!t.ok){ toast(t.why, "bad"); return; }
      if(!code){ toast("Kode wajib diisi.", "bad"); return; }

      const username = u.v;
      const trx_ref  = t.v;

      if(hasOpenedBox(username, trx_ref)){
        toast("Box untuk TRX ini sudah dibuka. Tidak bisa aktivasi ulang.", "bad");
        return;
      }

      const claim = findClaim(username, trx_ref);
      if(!claim || claim.status !== "verified"){
        toast("Claim belum diverifikasi CS untuk username+TRX ini.", "warn");
        return;
      }

      const activeCode = getLatestActiveCode(username, trx_ref);
      if(!activeCode){
        toast("Tidak ada kode aktif. Minta CS issue kode baru.", "warn");
        return;
      }

      if(activeCode.attempts_left <= 0){
        toast("Limit 3x salah tercapai. Minta CS issue kode baru.", "bad");
        return;
      }

      const hash = await sha256Hex(code);
      if(hash !== activeCode.code_hash){
        activeCode.attempts_left = Math.max(0, activeCode.attempts_left - 1);
        addAudit(`Gagal kode: ${username} • ${trx_ref} (sisa ${activeCode.attempts_left}x)`);
        save();
        toast(`Kode salah. Sisa percobaan: ${activeCode.attempts_left}x`, activeCode.attempts_left ? "warn":"bad");
        return;
      }

      // valid: consume code & activate box
      activeCode.used_at = now();
      addAudit(`Kode dipakai: ${username} • ${trx_ref}`);

      let box = findBox(username, trx_ref);
      if(!box){
        // safety, should exist
        box = {
          id: uid("bx"),
          claim_id: claim.id,
          username, trx_ref,
          nominal: claim.nominal || 20000,
          status: "active",
          created_at: now(),
          activated_at: now(),
          opened_at: null
        };
        state.boxes.unshift(box);
      }else{
        if(box.opened_at){
          toast("Box sudah dibuka. Aktivasi dibatalkan.", "bad");
          return;
        }
        box.status = "active";
        box.activated_at = now();
      }

      toast("Box aktif ✅ Silakan buka box kamu.", "good");
      $("a_code").value = "";
      save();
    }

    function weightedPick(){
      const total = ODDS.reduce((s,x)=>s + Number(x.pct||0), 0);
      const r = randFloat01() * (total || 1);
      let acc=0;
      for(const item of ODDS){
        acc += Number(item.pct||0);
        if(r <= acc) return item;
      }
      return ODDS[ODDS.length-1];
    }

    function rewardLabel(r){
      // reward hasil openBox menyimpan label final di r.title
      if(r && r.title) return r.title;

      // fallback: item ODDS
      const d = (r && (r.data || r.payload)) || {};
      if(r.type === "cashback") return `Cashback ${d.percent}% (maks ${fmtMoney(d.cap)})`;
      if(r.type === "spin")     return `Spin ${d.spins}x — ${fmtMoney(d.bet)}/spin`;
      if(r.type === "voucher")  return `Voucher ${fmtMoney(d.amount)}`;
      return "Hadiah";
    }

    function openBox(boxId){
      const box = state.boxes.find(b=>b.id===boxId);
      if(!box) return;

      if(box.status !== "active"){
        toast("Box belum aktif. Aktivasi pakai kode dulu.", "warn");
        return;
      }
      if(box.opened_at){
        toast("Box ini sudah dibuka.", "warn");
        return;
      }

      const pick = weightedPick();
      const reward = {
        id: uid("rw"),
        box_id: box.id,
        username: box.username,
        trx_ref: box.trx_ref,
        created_at: now(),
        type: pick.type,
        title: pick.label,
        expires_at: now() + 24*60*60*1000,
        status: "granted",
        payload: {}
      };

      if(pick.type === "cashback"){
        const percent = pick.data.percent;
        const cap = pick.data.cap;
        const amountRaw = Math.floor(box.nominal * (percent/100));
        const amount = Math.min(amountRaw, cap);
        reward.payload = { percent, cap, amount };
      }

      if(pick.type === "spin"){
        reward.payload = {
          spins: pick.data.spins,
          bet: pick.data.bet,
          provider: null,
          spins_done: 0
        };
      }

      if(pick.type === "voucher"){
        reward.payload = {
          amount: pick.data.amount,
          code: "VC-" + randCode(10) // demo voucher code
        };
      }

      box.opened_at = now();
      box.status = "opened";

      state.rewards.unshift(reward);
      addAudit(`Box dibuka: ${box.username} • ${box.trx_ref} → ${rewardLabel(reward)}`);
      toast("🎁 Selamat! Hadiah keluar.", "good");
      save();
    }

    function setProvider(rewardId, provider){
      const r = state.rewards.find(x=>x.id===rewardId);
      if(!r || r.type !== "spin") return;
      if(r.expires_at <= now() || r.status === "expired"){
        toast("Reward sudah expired (24 jam).", "bad");
        return;
      }
      r.payload.provider = provider;
      addAudit(`Provider dipilih: ${r.username} • ${r.trx_ref} → ${provider}`);
      toast(`Provider dipilih: ${provider}`, "good");
      save();
    }

    function simulateSpin(rewardId){
      const r = state.rewards.find(x=>x.id===rewardId);
      if(!r || r.type !== "spin") return;
      if(r.expires_at <= now() || r.status === "expired"){
        toast("Reward sudah expired (24 jam).", "bad");
        return;
      }
      if(!r.payload.provider){
        toast("Pilih provider dulu (Pragmatic / PGSoft).", "warn");
        return;
      }

      const total = r.payload.spins;
      const step = Math.min(5, total - (r.payload.spins_done||0));
      r.payload.spins_done = (r.payload.spins_done||0) + step;

      if(r.payload.spins_done >= total){
        r.payload.spins_done = total;
        r.status = "completed";
        addAudit(`Spin selesai: ${r.username} • ${r.trx_ref} (${total}x)`);
        toast("Spin selesai ✅ (demo)", "good");
      }else{
        toast(`Progress spin: ${r.payload.spins_done}/${total}`, "good");
      }
      save();
    }

    function copyText(text){
      const v = String(text ?? "");
      navigator.clipboard?.writeText(v).then(()=> toast("Disalin ke clipboard.", "good"))
      .catch(()=> toast("Gagal copy (browser).", "warn"));
    }

    /* =========================
      BLOK 21 — UI / TAB
    ========================== */
    function setTab(which){
      const isMember = which === "member";
      $("tabMember").setAttribute("aria-selected", isMember ? "true":"false");
      $("tabCS").setAttribute("aria-selected", isMember ? "false":"true");
      $("tabMember").tabIndex = isMember ? 0 : -1;
      $("tabCS").tabIndex = isMember ? -1 : 0;
      $("viewMember").style.display = isMember ? "" : "none";
      $("viewCS").style.display = isMember ? "none" : "";
    }

    function setupTabsA11y(){
      const tabs = [$("tabMember"), $("tabCS")];
      function focusTab(i){ tabs[i].focus(); }
      tabs.forEach((tab, idx)=>{
        tab.addEventListener("keydown", (e)=>{
          if(e.key === "ArrowRight" || e.key === "ArrowLeft"){
            e.preventDefault();
            const next = e.key === "ArrowRight" ? (idx+1)%tabs.length : (idx-1+tabs.length)%tabs.length;
            focusTab(next);
            setTab(next===0 ? "member":"cs");
          }
        });
      });
    }

    $("tabMember").addEventListener("click", ()=> setTab("member"));
    $("tabCS").addEventListener("click", ()=> setTab("cs"));

    /* =========================
      BLOK 22 — MEMBER EVENTS
    ========================== */
    $("btnFillDemo").addEventListener("click", ()=>{
      const uname = "garr" + Math.floor(100 + Math.random()*900);
      $("m_username").value = uname;
      $("m_nominal").value = "20000";
      $("m_trx").value = "TRX-" + new Date().toISOString().slice(0,10).replaceAll("-","") + "-" + Math.floor(10 + Math.random()*90);
      $("m_proof").value = "bukti opsional";
      $("a_username").value = uname;
      $("a_trx").value = $("m_trx").value;
      toast("Contoh form diisi.", "good");
      renderMember(); // live filter
    });

    $("btnSubmitClaim").addEventListener("click", ()=>{
      const u = normalizeUsername($("m_username").value);
      const t = normalizeTRX($("m_trx").value);
      const proof = String($("m_proof").value||"").trim();
      const nominalRaw = parseNominal($("m_nominal").value);
      const { ok, v:nominal } = validateNominalMin(nominalRaw);

      if(!u.ok){ toast(u.why, "bad"); return; }
      if(!t.ok){ toast(t.why, "bad"); return; }
      if(!ok){ toast("Nominal minimal Rp20.000.", "warn"); return; }

      const username = u.v;
      const trx_ref = t.v;

      const existing = findClaim(username, trx_ref);
      if(existing){
        if(existing.status === "rejected"){
          toast("Claim ini pernah ditolak. Buat TRX baru / hubungi CS.", "warn");
        }else{
          toast("Claim untuk TRX ini sudah ada.", "warn");
        }
        return;
      }

      if(hasOpenedBox(username, trx_ref)){
        toast("TRX ini sudah pernah dibuka. Gunakan TRX lain.", "warn");
        return;
      }

      state.claims.unshift({
        id: uid("cl"),
        username,
        trx_ref,
        nominal,
        proof,
        status: "pending",
        created_at: now(),
        reviewed_at: null
      });

      addAudit(`Claim masuk: ${username} • ${trx_ref} • ${fmtMoney(nominal)}`);
      toast("Claim dikirim. Menunggu verifikasi CS.", "good");

      // convenience
      $("a_username").value = username;
      $("a_trx").value = trx_ref;

      save();
    });

    $("btnActivate").addEventListener("click", activateBox);

    // Mirror username typed in claim to activation (small UX)
    $("m_username").addEventListener("input", ()=>{
      const v = $("m_username").value.trim();
      if(v && !$("a_username").value.trim()) $("a_username").value = v;
      renderMember();
    });
    $("a_username").addEventListener("input", renderMember);
    $("a_trx").addEventListener("input", renderMember);

    /* =========================
      BLOK 23 — CS EVENTS
    ========================== */
    $("btnSeedDemo").addEventListener("click", ()=>{
      const mk = (u, t, n)=>({
        id: uid("cl"),
        username:u, trx_ref:t, nominal:n, proof:"",
        status:"pending", created_at:now(), reviewed_at:null
      });
      const d1 = "demo" + Math.floor(100+Math.random()*900);
      const d2 = "demo" + Math.floor(100+Math.random()*900);
      state.claims.unshift(mk(d1, "TRX-DEMO-" + Math.floor(1000+Math.random()*9000), 20000));
      state.claims.unshift(mk(d2, "TRX-DEMO-" + Math.floor(1000+Math.random()*9000), 50000));
      addAudit("CS membuat 2 claim dummy.");
      toast("2 claim dummy dibuat.", "good");
      save();
    });

    $("btnResetAll").addEventListener("click", ()=>{
      localStorage.removeItem(STORE_KEY_V2);
      localStorage.removeItem(STORE_KEY_V1);
      location.reload();
    });

    /* =========================
      BLOK 24 — RENDER (SAFE DOM)
    ========================== */
    function el(tag, attrs={}, children=[]){
      const node = document.createElement(tag);
      for(const [k,v] of Object.entries(attrs||{})){
        if(k === "class") node.className = v;
        else if(k === "text") node.textContent = v;
        else if(k === "html") node.innerHTML = v; // use only for safe static bits
        else if(k.startsWith("data-")) node.setAttribute(k, v);
        else if(k === "title") node.title = v;
        else if(k === "disabled") node.disabled = !!v;
        else node.setAttribute(k, v);
      }
      const arr = Array.isArray(children) ? children : [children];
      for(const c of arr){
        if(c == null) continue;
        if(typeof c === "string") node.appendChild(document.createTextNode(c));
        else node.appendChild(c);
      }
      return node;
    }

    function tagBadge(text, kind=""){
      return el("span",{class:"tag"+(kind?(" "+kind):""), text});
    }

    function clear(node){
      while(node.firstChild) node.removeChild(node.firstChild);
    }

    function renderOdds(){
      const tb = $("oddsTbody");
      clear(tb);
      const total = ODDS.reduce((s,x)=>s + Number(x.pct||0),0);

      for(const o of ODDS){
        const tr = document.createElement("tr");
        const td1 = document.createElement("td");
        const td2 = document.createElement("td");
        td1.textContent = o.label;
        td2.className = "pct";
        td2.textContent = (Number(o.pct)%1===0 ? Number(o.pct).toFixed(0) : Number(o.pct).toFixed(2)) + "%";
        tr.appendChild(td1); tr.appendChild(td2);
        tb.appendChild(tr);
      }

      const tr = document.createElement("tr");
      const td1 = document.createElement("td");
      const td2 = document.createElement("td");
      td1.innerHTML = "<b>Total</b>";
      td2.className = "pct";
      td2.innerHTML = "<b>"+(total%1===0?total.toFixed(0):total.toFixed(2))+"%</b>";
      tr.appendChild(td1); tr.appendChild(td2);
      tb.appendChild(tr);
    }

    function currentFilterUsername(){
      return String($("m_username").value||$("a_username").value||"").trim();
    }

    function renderMember(){
      const usernameFilter = currentFilterUsername();

      // BOXES
      const myBoxes = $("myBoxes");
      clear(myBoxes);

      const boxes = state.boxes
        .filter(b => !usernameFilter || b.username === usernameFilter)
        .sort((a,b)=>(b.created_at||0)-(a.created_at||0));

      if(boxes.length === 0){
        myBoxes.appendChild(el("div",{class:"note", text:"Belum ada box. Ajukan claim dulu, lalu aktivasi pakai kode."}));
      }else{
        for(const b of boxes){
          const left = el("div",{class:"left"});
          const right = el("div",{class:"right"});

          const title = el("p",{class:"title"});
          title.appendChild(document.createTextNode("Box • "));
          title.appendChild(el("span",{class:"mono", text: b.trx_ref}));

          const meta = el("p",{class:"meta"});
          meta.appendChild(document.createTextNode("User: "));
          meta.appendChild(el("b",{text: b.username}));
          meta.appendChild(document.createTextNode(" • Nominal: "));
          meta.appendChild(el("b",{text: fmtMoney(b.nominal)}));
          meta.appendChild(document.createElement("br"));
          meta.appendChild(document.createTextNode("Dibuat: " + fmtTime(b.created_at)));
          if(b.activated_at) meta.appendChild(document.createTextNode(" • Aktif: " + fmtTime(b.activated_at)));
          if(b.opened_at) meta.appendChild(document.createTextNode(" • Dibuka: " + fmtTime(b.opened_at)));

          left.appendChild(title);
          left.appendChild(meta);

          let stTag = tagBadge("OPENED");
          if(b.status === "active") stTag = tagBadge("ACTIVE","good");
          if(b.status === "locked") stTag = tagBadge("LOCKED","warn");

          right.appendChild(stTag);

          if(b.status === "active" && !b.opened_at){
            const btn = el("button",{class:"btn primary","data-open":b.id});
            btn.appendChild(el("span",{class:"k", text:"🎁"}));
            btn.appendChild(document.createTextNode(" Buka Box"));
            right.appendChild(btn);
          }

          myBoxes.appendChild(el("div",{class:"item"},[left,right]));
        }
      }

      // REWARDS
      const myRewards = $("myRewards");
      clear(myRewards);

      const rewards = state.rewards
        .filter(r => !usernameFilter || r.username === usernameFilter)
        .sort((a,b)=>(b.created_at||0)-(a.created_at||0));

      if(rewards.length === 0){
        myRewards.appendChild(el("div",{class:"note", text:"Belum ada hadiah. Buka box untuk mendapatkan hadiah."}));
      }else{
        const t = now();
        for(const r of rewards){
          const isExpired = (r.status === "expired") || (r.expires_at <= t);
          const leftMs = Math.max(0, r.expires_at - t);

          const left = el("div",{class:"left"});
          const right = el("div",{class:"right"});

          const title = el("p",{class:"title", text: rewardLabel(r) });

          const meta = el("p",{class:"meta"});
          meta.appendChild(document.createTextNode("User: "));
          meta.appendChild(el("b",{text:r.username}));
          meta.appendChild(document.createTextNode(" • TRX: "));
          meta.appendChild(el("span",{class:"mono", text:r.trx_ref}));
          meta.appendChild(document.createElement("br"));
          meta.appendChild(document.createTextNode("Didapat: " + fmtTime(r.created_at) + " • "));

          const cd = el("span",{class:"mono", "data-expire": String(r.expires_at), "data-kind":"reward"});
          cd.textContent = isExpired ? "EXPIRED" : ("AKTIF " + fmtLeftHours(leftMs));
          meta.appendChild(cd);

          // detail + actions
          const actions = el("div",{class:"right"});
          actions.appendChild(isExpired ? tagBadge("EXPIRED","bad") : tagBadge("AKTIF","good"));

          if(r.type === "cashback"){
            const p = r.payload || {};
            meta.appendChild(document.createElement("br"));
            meta.appendChild(document.createTextNode(`Cashback: ${fmtMoney(p.amount||0)} (dari ${p.percent||0}% • cap ${fmtMoney(p.cap||0)})`));
            actions.appendChild(tagBadge("Instant"));
          }

          if(r.type === "voucher"){
            const p = r.payload || {};
            meta.appendChild(document.createElement("br"));
            meta.appendChild(document.createTextNode(`Voucher: ${fmtMoney(p.amount||0)} • Code: `));
            meta.appendChild(el("span",{class:"mono", text: String(p.code||"—")}));
            if(!isExpired){
              actions.appendChild(el("button",{class:"btn ghost","data-copy":String(p.code||"")},[
                el("span",{class:"k",text:"⧉"}), document.createTextNode(" Copy code")
              ]));
            }
          }

          if(r.type === "spin"){
            const p = r.payload || {};
            meta.appendChild(document.createElement("br"));
            meta.appendChild(document.createTextNode(`Spin manual: ${p.spins||0}x — ${fmtMoney(p.bet||0)}/spin • Provider: `));
            meta.appendChild(el("b",{text: p.provider || "Belum dipilih"}));
            meta.appendChild(document.createElement("br"));
            meta.appendChild(document.createTextNode(`Progress (demo): ${p.spins_done||0}/${p.spins||0}`));

            const disabled = isExpired;

            actions.appendChild(el("button",{class:"btn ghost",disabled:disabled,"data-prov":r.id,"data-p":"PRAGMATIC PLAY"},[
              el("span",{class:"k",text:"PP"}), document.createTextNode(" Pragmatic")
            ]));
            actions.appendChild(el("button",{class:"btn ghost",disabled:disabled,"data-prov":r.id,"data-p":"PGSOFT"},[
              el("span",{class:"k",text:"PG"}), document.createTextNode(" PGSoft")
            ]));

            actions.appendChild(el("button",{class:"btn primary",disabled:disabled,"data-spin":r.id},[
              el("span",{class:"k",text:"▶"}), document.createTextNode(" Simulasi Spin")
            ]));
          }

          left.appendChild(title);
          left.appendChild(meta);

          myRewards.appendChild(el("div",{class:"item"},[left,actions]));
        }
      }
    }

    function renderCS(){
      // PENDING
      const csPending = $("csPending");
      clear(csPending);

      const pending = state.claims
        .filter(c=>c.status==="pending")
        .sort((a,b)=>(b.created_at||0)-(a.created_at||0));

      if(pending.length === 0){
        csPending.appendChild(el("div",{class:"note", text:"Tidak ada claim pending."}));
      }else{
        for(const c of pending){
          const left = el("div",{class:"left"});
          const right = el("div",{class:"right"});

          const title = el("p",{class:"title"});
          title.appendChild(document.createTextNode("Claim Pending • "));
          title.appendChild(el("span",{class:"mono", text:c.trx_ref}));

          const meta = el("p",{class:"meta"});
          meta.appendChild(document.createTextNode("User: "));
          meta.appendChild(el("b",{text:c.username}));
          meta.appendChild(document.createTextNode(" • Nominal: "));
          meta.appendChild(el("b",{text:fmtMoney(c.nominal)}));
          meta.appendChild(document.createElement("br"));
          meta.appendChild(document.createTextNode("Masuk: " + fmtTime(c.created_at)));
          if(c.proof){
            meta.appendChild(document.createElement("br"));
            meta.appendChild(document.createTextNode("Proof: "));
            meta.appendChild(el("span",{class:"mono", text:c.proof}));
          }

          left.appendChild(title);
          left.appendChild(meta);

          right.appendChild(el("button",{class:"btn good","data-approve":c.id},[
            el("span",{class:"k",text:"✓"}), document.createTextNode(" Approve")
          ]));
          right.appendChild(el("button",{class:"btn danger","data-reject":c.id},[
            el("span",{class:"k",text:"✕"}), document.createTextNode(" Reject")
          ]));

          csPending.appendChild(el("div",{class:"item"},[left,right]));
        }
      }

      // VERIFIED (reissue)
      const csVerified = $("csVerified");
      clear(csVerified);

      const verified = state.claims
        .filter(c=>c.status==="verified")
        .sort((a,b)=>(b.reviewed_at||0)-(a.reviewed_at||0));

      if(verified.length === 0){
        csVerified.appendChild(el("div",{class:"note", text:"Belum ada claim yang diverifikasi."}));
      }else{
        for(const c of verified){
          const left = el("div",{class:"left"});
          const right = el("div",{class:"right"});

          const title = el("p",{class:"title"});
          title.appendChild(document.createTextNode("Verified • "));
          title.appendChild(el("span",{class:"mono", text:c.trx_ref}));

          const meta = el("p",{class:"meta"});
          meta.appendChild(document.createTextNode("User: "));
          meta.appendChild(el("b",{text:c.username}));
          meta.appendChild(document.createTextNode(" • Nominal: "));
          meta.appendChild(el("b",{text:fmtMoney(c.nominal)}));
          meta.appendChild(document.createElement("br"));
          meta.appendChild(document.createTextNode("Verified: " + (c.reviewed_at ? fmtTime(c.reviewed_at) : "—")));

          const code = getClaimActiveCode(c);
          const box = findBox(c.username, c.trx_ref);
          const opened = !!(box && box.opened_at);

          left.appendChild(title);
          left.appendChild(meta);

          if(opened){
            right.appendChild(tagBadge("OPENED","bad"));
          }else if(code){
            const leftMs = msLeft(code.expires_at);
            right.appendChild(tagBadge("KODE AKTIF","good"));
            right.appendChild(el("span",{class:"tag", "data-expire":String(code.expires_at), "data-kind":"code"},[
              document.createTextNode("Sisa "), el("b",{text: fmtLeftCompact(leftMs)})
            ]));
          }else{
            right.appendChild(tagBadge("BUTUH KODE","warn"));
          }

          // always allow re-issue if not opened
          const btn = el("button",{class:"btn ghost", disabled:opened, "data-issue":c.id},[
            el("span",{class:"k",text:"♻"}), document.createTextNode(" Issue Kode")
          ]);
          right.appendChild(btn);

          csVerified.appendChild(el("div",{class:"item"},[left,right]));
        }
      }

      // CODES (active & recent)
      const csCodes = $("csCodes");
      clear(csCodes);

      const tnow = now();
      const codes = state.codes
        .filter(cd => !cd.used_at && !cd.superseded_at)
        .sort((a,b)=>(b.created_at||0)-(a.created_at||0))
        .slice(0, 20);

      if(codes.length === 0){
        csCodes.appendChild(el("div",{class:"note", text:"Belum ada kode aktif."}));
      }else{
        for(const cd of codes){
          const expired = cd.expires_at <= tnow;
          const leftMs = msLeft(cd.expires_at);

          const left = el("div",{class:"left"});
          const right = el("div",{class:"right"});

          const title = el("p",{class:"title"});
          title.appendChild(document.createTextNode("Kode Voucher • "));
          title.appendChild(el("span",{class:"mono", text:cd.trx_ref}));

          const meta = el("p",{class:"meta"});
          meta.appendChild(document.createTextNode("User: "));
          meta.appendChild(el("b",{text:cd.username}));
          meta.appendChild(document.createTextNode(" • Exp: " + fmtTime(cd.expires_at) + " • Attempts: "));
          meta.appendChild(el("b",{text: String(cd.attempts_left||0) + "x"}));
          meta.appendChild(document.createElement("br"));

          const preview = cd.code_preview ? cd.code_preview : "••••••••";
          meta.appendChild(el("span",{class:"mono"},[
            el("b",{text: preview})
          ]));
          meta.appendChild(document.createTextNode(" "));
          meta.appendChild(el("span",{class:"faint", text:"(demo-only tampilkan)"}));

          left.appendChild(title);
          left.appendChild(meta);

          right.appendChild(expired ? tagBadge("EXPIRED","bad") : tagBadge("AKTIF","good"));
          right.appendChild(el("span",{class:"tag", "data-expire":String(cd.expires_at), "data-kind":"code"},[
            document.createTextNode(expired ? "Expired" : "Sisa "),
            el("b",{text: expired ? "0m 00s" : fmtLeftCompact(leftMs)})
          ]));

          if(!expired && cd.code_preview){
            right.appendChild(el("button",{class:"btn ghost","data-copycode":cd.code_preview},[
              el("span",{class:"k",text:"⧉"}), document.createTextNode(" Copy kode")
            ]));
          }

          csCodes.appendChild(el("div",{class:"item"},[left,right]));
        }
      }

      // AUDIT
      const csAudit = $("csAudit");
      clear(csAudit);

      if(state.audit.length === 0){
        csAudit.appendChild(el("div",{class:"note", text:"Belum ada aktivitas."}));
      }else{
        for(const a of state.audit.slice(0, 22)){
          const left = el("div",{class:"left"});
          const right = el("div",{class:"right"});

          left.appendChild(el("p",{class:"title", text:a.text}));
          left.appendChild(el("p",{class:"meta", text: fmtTime(a.ts)}));

          right.appendChild(tagBadge("LOG"));

          csAudit.appendChild(el("div",{class:"item"},[left,right]));
        }
      }
    }

    function renderPill(){
      const pending = state.claims.filter(c=>c.status==="pending").length;
      const active = state.codes.filter(cd=>!cd.used_at && !cd.superseded_at && cd.expires_at>now() && (cd.attempts_left||0)>0).length;
      $("pillStatus").textContent = pending ? `${pending} claim pending` : (active ? `${active} kode aktif` : "Siap digunakan");
    }

    function renderAll(){
      renderOdds();
      renderMember();
      renderCS();
      renderPill();
    }

    /* =========================
      BLOK 25 — EVENT DELEGATION (NO re-bind per render)
    ========================== */
    $("myBoxes").addEventListener("click", (e)=>{
      const btn = e.target.closest("[data-open]");
      if(!btn) return;
      openBox(btn.getAttribute("data-open"));
    });

    $("myRewards").addEventListener("click", (e)=>{
      const copy = e.target.closest("[data-copy]");
      if(copy) return copyText(copy.getAttribute("data-copy"));

      const prov = e.target.closest("[data-prov]");
      if(prov) return setProvider(prov.getAttribute("data-prov"), prov.getAttribute("data-p"));

      const spin = e.target.closest("[data-spin]");
      if(spin) return simulateSpin(spin.getAttribute("data-spin"));
    });

    $("csPending").addEventListener("click", (e)=>{
      const a = e.target.closest("[data-approve]");
      if(a) return csApprove(a.getAttribute("data-approve"));

      const r = e.target.closest("[data-reject]");
      if(r) return csReject(r.getAttribute("data-reject"));
    });

    $("csVerified").addEventListener("click", (e)=>{
      const i = e.target.closest("[data-issue]");
      if(i) return issueCodeForClaim(i.getAttribute("data-issue"));
    });

    $("csCodes").addEventListener("click", (e)=>{
      const c = e.target.closest("[data-copycode]");
      if(c) return copyText(c.getAttribute("data-copycode"));
    });

    /* =========================
      BLOK 26 — LIGHT TICK (COUNTDOWNS ONLY)
    ========================== */
    let tickTimer = null;

    function tickCountdowns(){
      const t = now();
      // update countdown badges by data-expire
      const nodes = document.querySelectorAll("[data-expire]");
      nodes.forEach(n=>{
        const exp = Number(n.getAttribute("data-expire")||0);
        const ms = Math.max(0, exp - t);
        const kind = n.getAttribute("data-kind") || "";
        const expired = ms <= 0;

        if(kind === "reward"){
          n.textContent = expired ? "EXPIRED" : ("AKTIF " + fmtLeftHours(ms));
        }else{
          // code
          const b = n.querySelector("b");
          if(b) b.textContent = expired ? "0m 00s" : fmtLeftCompact(ms);
        }
      });

      // update pill only (cheap)
      renderPill();

      // derive reward expiry without full render
      let changed = false;
      for(const r of state.rewards){
        if(r.status !== "expired" && r.status !== "completed" && r.expires_at <= t){
          r.status = "expired";
          changed = true;
        }
      }
      if(changed){
        // save silently once (avoid loops)
        localStorage.setItem(STORE_KEY_V2, JSON.stringify(state));
        renderMember(); // refresh only member rewards view
      }
    }

    function startTick(){
      if(tickTimer) clearInterval(tickTimer);
      tickTimer = setInterval(()=>{
        if(document.visibilityState !== "visible") return;
        tickCountdowns();
      }, 1000);

      document.addEventListener("visibilitychange", ()=>{
        if(document.visibilityState === "visible"){
          tickCountdowns();
        }
      });
    }

    /* =========================
      BLOK 27 — INIT
    ========================== */
    setupTabsA11y();
    renderAll();
    startTick();
  </script>
</body>
</html>
